@page "/Tactics/{ID}"
@namespace Wildblood.Tactics.Components.Pages
@using MongoDB.Bson
@using Wildblood.Tactics.Entities
@using MongoDB.Driver;
@using Wildblood.Tactics.Models
@inject IJSRuntime JS;
@inject IMongoDatabase Database;
@rendermode InteractiveServer

<div class="parent">
    <div style="grid-area: 1/1/6/2;">
        <canvas id="tacticsCanvas" width="1200px" height="700px" style="border:1px solid #000000;" @onmousedown="drag" @onmouseup="dragStop" @onmousemove="dragMove"></canvas>
    </div>
    <div style="grid-area: 1/2/2/3;" id="MapSelectionDiv">
        <select @bind="Map" @bind:after="MapChanged" class="select">
            @foreach (var dir in Directory.EnumerateFiles(baseMapPath, "*", SearchOption.AllDirectories).Select(f => Path.GetFileName(f).Split('.')[0]))
            {
                <option value="@dir">@dir</option>
            }
        </select>
    </div>
    <div style="grid-area: 2/2/3/3;">
        <div id="UnitSelection" class="border-1 border border-primary">
            @foreach (var dir in Directory.EnumerateFiles(baseUnitPath, "*", SearchOption.AllDirectories).Select(f => Path.GetFileName(f)))
            {
                <div @onclick="@(async (args) => await selectedUnitChanged(dir))">
                    <img src="/ConquerorsBladeData/Units/@dir" height="40" width="40"/>
                </div>

            }
        </div>
    </div>
    <div style="grid-area: 5/2/6/4">
        <div>
            @foreach (var folder in tactic.Folders)
            {

                <div>
                    <div>
                        <h3>@folder.Name</h3>
                        <button class="btn btn-info" @onclick="async () => await onClickFolderRename(folder.Id)">Rename</button>
                    </div>
                    @foreach (var slide in folder.Slides)
                    {
                        <ul>
                            <li>@slide.Name</li>
                        </ul>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {

    [Parameter]
    public string? ID { get; set; }

    private Tactic? tactic;

    private List<IIcon> currentIcons = new List<IIcon>();

    private static string baseMapPath = "wwwroot/ConquerorsBladeData/Maps";
    private static string baseUnitPath = "wwwroot/ConquerorsBladeData/Units";
    private string? Map;
    private string? selectedUnit;
    private IMongoCollection<Tactic>? collection;

    private Unit? draggingIcon;
    private bool isDragging = false;

    protected override void OnParametersSet()
    {
        if (ID != null)
        {
            collection = Database.GetCollection<Tactic>("Tactics");
            tactic = collection.Find(t => t.Id == ID).FirstOrDefault();
            // tactic.Folders.ForEach(folder => folder.Slides.ForEach(slide => slide.Icons.ForEach(icon => currentIcons.Add(icon))));
        }

    }

    public Task selectedUnitChanged(string unit)
    {
        selectedUnit = unit;
        return Task.CompletedTask;
    }

    public async Task MapChanged()
    {
        await JS.InvokeVoidAsync("setBackground", Map);
    }


    private async Task placeIcon(MouseEventArgs eventArgs)
    {
        var unit = new Unit(eventArgs.OffsetX, eventArgs.OffsetY, "/ConquerorsBladeData/Units/" + selectedUnit);

        await JS.InvokeVoidAsync("placeIcon", unit);

        currentIcons.Add(unit);
    }

    private async Task drag(MouseEventArgs eventArgs)
    {
        var mouseX = eventArgs.OffsetX;
        var mouseY = eventArgs.OffsetY;

        foreach (var icon in currentIcons)
        {
            if (mouseX > icon.X && mouseX < icon.X + icon.Width && mouseY > icon.Y && mouseY < icon.Y + icon.Height)
            {
                draggingIcon = new Unit(icon.X, icon.Y, icon.FilePath, icon.Height, icon.Width);
                isDragging = true;
                currentIcons.Remove(icon);
                return;
            }
        }

        await placeIcon(eventArgs);

    }

    private async Task dragMove(MouseEventArgs args)
    {
        if (!isDragging || draggingIcon == null)
        {
            return;
        }
        draggingIcon.X = args.OffsetX;
        draggingIcon.Y = args.OffsetY;
        currentIcons.Add(draggingIcon);
        await JS.InvokeVoidAsync("draw", currentIcons);
        currentIcons.Remove(draggingIcon);
    }

    private async Task dragStop()
    {
        if (!isDragging)
        {
            return;
        }
        isDragging = false;
        currentIcons.Add(draggingIcon);
        await JS.InvokeVoidAsync("draw", currentIcons);
    }

    private async Task onClickFolderRename(string folderId)
    {
        var folder = tactic.Folders.First(f => f.Id == folderId);
        var newName = await JS.InvokeAsync<string>("prompt", "Enter new name", folder.Name);
        if (newName != null)
        {
            // it is infact a referece! 
            folder.Name = newName;
            
        }
    }
}
